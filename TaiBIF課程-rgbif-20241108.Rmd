---
title: "TaBIFèª²ç¨‹-rgbif-20241108"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

# ç”Ÿç‰©å¤šæ¨£æ€§è³‡æ–™æ‡‰ç”¨èª²ç¨‹ - ä½¿ç”¨ `rgbif` å¥—ä»¶

##### tags: `è³‡æ–™æ‡‰ç”¨` `è³‡æ–™æ¸…ç†` `API` `GBIF` `TaiBIF` `TBIA`

</br >

### ğŸ“’ æ­¤æ•™æä¾†è‡ª 2024/11 æ‰€èˆ‰è¾¦çš„ã€Œ[TaiBIF](https://portal.taibif.tw/) ç”Ÿç‰©å¤šæ¨£æ€§è³‡æ–™æ‡‰ç”¨å·¥ä½œåŠã€
#### **Created by:** ä½•èŠ·è”š [Daphne Hoh](https://orcid.org/0000-0002-7810-1034), å³ä¿Šæ¯… Junyi Wu
#### **Created:** 2024-09-02
#### **Last modified:** 2024-10-30

</br >

## ğŸš© èª²ç¨‹ç›®æ¨™
#### 1. å­¸æœƒæ€éº¼ç”¨ R å¥—ä»¶ [*`rgbif`*](https://docs.ropensci.org/rgbif/) ä¸‹è¼‰ GBIF è³‡æ–™
#### 2. å­¸æœƒæ€éº¼ç”¨ TBIA API ä¸‹è¼‰ TBIA è³‡æ–™
#### 3. äº†è§£ GBIF èˆ‡ TBIA æ‰€ä¸‹è¼‰çš„è³‡æ–™å¯èƒ½æœƒå‡ºç¾çš„å“è³ªå•é¡Œ (potential data quality issue)
#### 4. ç•«å‡ºç‰©ç¨®å‡ºç¾ç´€éŒ„åˆ†å¸ƒåœ–
#### 5. å¦‚ä½•å¼•ç”¨æ‰€ä¸‹è¼‰çš„è³‡æ–™


</br >

## ğŸª„ èª²å‰æº–å‚™
#### 1. æ­¤ HTML æ–‡ä»¶[é€£çµ](https://drive.google.com/file/d/1TrJgT5ksexdpoEraVJzZh3HIzGGJrTpc/view?usp=drive_link)
#### 2. å­¸å“¡æ–‡ä»¶å¤¾[é€£çµ](https://drive.google.com/drive/folders/1MQ5c3dWajjJdp5LBPwkFjvi-ENKY-8jV?usp=drive_link)
#### 3. é€™æ¬¡èª²å ‚è£¡æ‰€ä½¿ç”¨çš„å·¥å…·ç‰ˆæœ¬ï¼š
  + R ç‰ˆæœ¬ï¼š4.4.1
  + *`rgbif`* ç‰ˆæœ¬ï¼š3.8.1


</br >

##  ğŸ’» ç’°å¢ƒæº–å‚™
```{r, message = F}
# é›™å¼•è™Ÿä¹‹é–“çš„æ–‡å­—è¦æ”¹ç‚ºè‡ªå·±çš„æª”æ¡ˆè·¯å¾‘
setwd("/Users/taibif/Desktop/202411_rgbif") # Mac
setwd("C:/Users/taibif/Desktop/202411_rgbif") # Window

.packs <- c("rgbif", "data.table", "arrow", "ggplot2",
            "devtools", "tidyverse", "CoordinateCleaner", 
            "rnaturalearth", "sf", "ggmap", "jsonlite", 
            "progressr", "lubridate", "raster")
```


```{r, message = F}
#install.packages(.packs)
sapply(.packs, require, character.only = T)

# ä¸‹åˆ—å¥—ä»¶éœ€è¦ä½¿ç”¨ devtools ä¾†è£ 
devtools::install_github("ropensci/rnaturalearthhires")
library(rnaturalearthhires)

# è·‘å‡ºæ­¤ Rmd æ•™æçš„é›»è…¦èˆ‡ R ç’°å¢ƒè¨­å®š
sessionInfo()
```

</br >

## (1) ğŸ” ä½¿ç”¨ rgbif å¥—ä»¶ä¾†ä¸‹è¼‰ GBIF çš„è³‡æ–™
### 1.1 - æ‰¾å‡ºç‰©ç¨®çš„ taxonKey
#### é€™æ¬¡çš„èª²å ‚ç¯„ä¾‹ï¼Œæˆ‘å€‘ä¾†çœ‹è‡ºç£çš„åŸç”Ÿç‰©ç¨®â€”é»‘å† éº»é·º *Gorsachius melanolophus*
```{r}
# æ–¹æ³•ï¼ˆä¸€ï¼‰ï¼šåˆ° GBIF ç¶²ç«™æ‰¾ https://www.gbif.org/species/"XXXXXXX"
taxonKey <- 2480841

# æ–¹æ³•ï¼ˆäºŒï¼‰ï¼š
name_backbone(name = "Gorsachius melanolophus", rank = "species") %>% 
  data.frame()
```
#### + æ³¨æ„ `status` æ¬„ä½æª¢æŸ¥è¼¸å…¥çš„å­¸åæ˜¯å¦æœ‰æ•ˆ
#### + æ³¨æ„ `matchType` æ¬„ä½æª¢æŸ¥è¼¸å…¥çš„å­¸åæ˜¯å¦ç‚ºä½ è¦æ‰¾çš„ç‰©ç¨®æˆ–æ˜¯å¦æ‹¼éŒ¯
#### + ç¯„ä¾‹åƒè€ƒï¼š
####    + name_backbone(name = "Magnoliophyta") # `status` æ˜¯ 'Synonym' (åŒç‰©ç•°å)
####    + name_backbone(name = "Aegithalos caudatus") # `status` æ˜¯ 'Doubtful' (æœ‰ç–‘æ…®çš„)
```{r}
# ä¸Šé¢æª¢æŸ¥æ²’å•é¡Œå¾Œï¼Œå­˜å…¥ taxonKey
taxonKey <- name_backbone(name = "Gorsachius melanolophus", rank = "species") %>% 
  pull(usageKey)
```

</br >

### 1.2 - é‡å° taxonKey ä¸‹è¼‰å‡ºç¾ç´€éŒ„
```{r, message = F}
# è¦ç™»å…¥ GBIF å¸³è™Ÿæ‰èƒ½ä¸‹è¼‰è³‡æ–™
gbif_download_key <- occ_download(pred("taxonKey", taxonKey), # ä¸‹è¼‰æ­¤ taxonKey çš„å‡ºç¾ç´€éŒ„
                                  format = "SIMPLE_CSV",
                                  user = "yourName", # è¼¸å…¥ä½ çš„ GBIF User ID
                                  pwd = "yourPW", # å¯†ç¢¼
                                  email = "yourEmail@gmail.com") # ç”¨ä¾†è¨»å†Š GBIF å¸³è™Ÿçš„ email

# æŸ¥çœ‹ä¸‹è¼‰ç‹€æ…‹
# å¦‚æœè³‡æ–™å¾ˆå¤šï¼Œæœƒéœ€è¦ç­‰ä¸€é™£å­
occ_download_wait(gbif_download_key)

# ç›´æ¥è®€é€² R æˆ data frame
# ä¹Ÿå¦å­˜ä¸€å€‹å£“ç¸®æª”åˆ°æœ¬æ©Ÿè·¯å¾‘
gbif_download <- occ_download_get(gbif_download_key, overwrite = T) %>% 
  occ_download_import()

head(gbif_download, 5) 
colnames(gbif_download) # çœ‹çœ‹æœ‰ä»€éº¼æ¬„ä½
```
#### + çœ‹å„æ¬„ä½ä»£è¡¨ä»€éº¼ï¼šDarwin Core (DwC) Terms https://dwc.tdwg.org/list/
#### + å®Œæ•´çš„ DwC Terms æœ‰è¶…é 350 å€‹
#### + rgbif çš„ occ_download_get å…±æœ‰ 50 å€‹
#### + æœ‰ä¸€äº›æ¬„ä½ä¾‹å¦‚ï¼šgbifID, lastInterpreted, mediaType, issue ç­‰æ˜¯ GBIF è©®é‡‹è³‡æ–™ï¼Œä¸æ˜¯ DwC

</br >

## (2) ğŸ” ä½¿ç”¨ TBIA API ä¾†ä¸‹è¼‰ TBIA çš„è³‡æ–™
### 2.1 - æ‰¾å‡ºç‰©ç¨®çš„ taxonID
#### æˆ‘å€‘ä¾†çœ‹è‡ºç£çš„åŸç”Ÿç‰©ç¨®â€”é»‘å† éº»é·º *Gorsachius melanolophus*
```{r}
# åˆ° TaiCOL ç¶²ç«™æ‰¾ https://taicol.tw/zh-hant/taxon/"txxxxxxx"
taxonID <- "t0064796"

# ç”¨ TaiCOL API æª¢æŸ¥ç‰©ç¨®è³‡è¨Šï¼š
splist <- fromJSON(sprintf("https://api.taicol.tw/v2/taxon?taxon_id=%s", taxonID))
splist$data
```
#### + æ³¨æ„ `taxon_status` æ¬„ä½æª¢æŸ¥è¼¸å…¥çš„å­¸åæ˜¯å¦æœ‰æ•ˆ
#### + ç¯„ä¾‹åƒè€ƒï¼š taxonID <- "t0082561" # `taxon_status` æ˜¯ 'Delete' (ç„¡æ•ˆå)

</br >

### 2.2 - é‡å° taxonID ä¸‹è¼‰å‡ºç¾ç´€éŒ„
#### TBIA API èªªæ˜æ–‡ä»¶ https://tbiadata.tw/zh-hant/api/doc
```{r, message = F}
# ä½¿ç”¨ TBIA API çš„ taxonID æŸ¥è©¢åƒæ•¸ä¸‹è¼‰ TBIA è§€æ¸¬ç´€éŒ„:
# 1. åˆå§‹ API å‘¼å«ï¼Œä¸‹è¼‰ç¬¬ä¸€é è³‡æ–™
initial_url <- sprintf("https://tbiadata.tw/api/v1/occurrence?taxonID=%s&isCollection=false&limit=1000", taxonID)
occurrence <- fromJSON(initial_url)
all_data <- list()  # åˆå§‹åŒ–åˆ—è¡¨ä¾†å„²å­˜æ‰€æœ‰é é¢çš„è³‡æ–™
all_data[[1]] <- occurrence$data

# 2. è¨ˆç®—ç¸½é æ•¸
pg <- floor(occurrence$meta$total / 1000)
if (occurrence$meta$total %% 1000 == 0) {  # ä¿®æ­£æ¯”è¼ƒç‚ºæ•¸å€¼ 0
  pg <- pg - 1  # é¿å…é æ•¸å‰›å¥½æ•´é™¤å°è‡´å¾Œé¢è¿´åœˆå‡ºéŒ¯
}

# 3. ä½¿ç”¨ progressr çš„ with_progress ä¾†é¡¯ç¤ºé€²åº¦æ¢
with_progress({
  p <- progressor(along = 1:pg)
  
  for(j in 1:pg){
    success <- FALSE
    while(!success) {
      TT_API <- tryCatch({
        # ä½¿ç”¨ä¸‹ä¸€é çš„é€£çµé€²è¡Œ API å‘¼å«
        occurrence <- fromJSON(occurrence$links$`next`)
        # æª¢æŸ¥ occurrence$data æ˜¯å¦ç‚ºç©º
        if(length(occurrence$data) == 0){
          message(sprintf("Page %d has no data. Skipping.", j))
        } else {
          # å°‡ç•¶å‰é çš„è³‡æ–™æ·»åŠ åˆ°åˆ—è¡¨
          all_data[[j + 1]] <- occurrence$data
        }
        success <- TRUE
      }, error = function(e) {
        message("Error occurred: ", e$message)
        message("Retrying after 5 seconds")
        Sys.sleep(5)  # å»¶é² 5 ç§’å¾Œé‡è©¦
        return(NULL)
      })
    }
    
    # æ›´æ–°é€²åº¦æ¢
    p(sprintf("Downloaded page %d", j))
  }
})

# 4. åˆä½µæ‰€æœ‰è³‡æ–™åˆ°ä¸€å€‹ data.table
TBIA_download <- rbindlist(all_data, fill = TRUE) %>% 
  as.data.frame( )

# 5. ç¢ºèªåˆä½µå¾Œçš„è³‡æ–™çµæ§‹
head(TBIA_download, 5) 
colnames(TBIA_download) # çœ‹çœ‹æœ‰ä»€éº¼æ¬„ä½
```
#### + ä½¿ç”¨ API è«‹å…ˆæ ¹æ“šæƒ³ä¸‹è¼‰çš„ç›®æ¨™æŒ‘é¸ä½¿ç”¨çš„åƒæ•¸
#### + æ³¨æ„ API å…±åŒåƒæ•¸èˆ‡é€£çµ API æœƒå–å¾—å¾—è³‡æ–™æ¶æ§‹
#### + æª¢æŸ¥ API å›å‚³æ¬„ä½ä»¥åŠæ ¼å¼æ˜¯å¦éƒ½ç¬¦åˆ API èªªæ˜æ–‡ä»¶

</br >


## (3)ï¸ ğŸ§­ GBI Fè³‡æ–™èˆ‡ TBIA è³‡æ–™åˆä½µ
```{r, message = F}
#### æŒ‘é¸ GBIF è³‡æ–™èˆ‡ TBIA è³‡æ–™çš„å…±é€šæ¬„ä½
#### æ–°å¢ä¸€å€‹æ¬„ä½ç¢ºèªé€™äº›è³‡æ–™ä¾†è‡ª GBIF
GBIF_download_filter <- gbif_download %>%
  dplyr::select(., basisOfRecord, establishmentMeans, decimalLatitude, decimalLongitude, 
                eventDate, year, month, day, elevation, countryCode, coordinateUncertaintyInMeters, species) %>% 
  mutate(from = "GBIF")

#### æŒ‘é¸ TBIA è³‡æ–™èˆ‡ GBIF è³‡æ–™çš„å…±é€šæ¬„ä½
#### æ–°å¢ä¸€å€‹æ¬„ä½ç¢ºèªé€™äº›è³‡æ–™ä¾†è‡ª TBIA
TBIA_download_filter <- TBIA_download %>%
  dplyr::select(., basisOfRecord, standardLatitude, standardLongitude, 
                standardDate, coordinateUncertaintyInMeters, scientificName) %>% 
  setnames(., c("standardLatitude", "standardLongitude", "standardDate", "scientificName"), 
           c("decimalLatitude", "decimalLongitude", "eventDate", "species")) %>%
  mutate(year = year(eventDate),
    month = month(eventDate),
    day = day(eventDate), 
    from = "TBIA")

combine_table <- rbindlist(list(GBIF_download_filter, TBIA_download_filter), fill = TRUE)

#### ç¢ºèªæ¬„ä½çš„è³‡æ–™æ ¼å¼å·®ç•°
# combine_table$year %>% table() %>% 
#   as.character()
# combine_table$coordinateUncertaintyInMeters %>% table() %>% 
#   as.character()


# ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æ‰¾å‡ºéæ•¸å­—çš„å€¼
non_numeric_entries <- combine_table %>%
  filter(!grepl("^\\d+(\\.\\d+)?$", coordinateUncertaintyInMeters))
# æ­£å‰‡è¡¨é”å¼è§£é‡‹ï¼š
# ^ å’Œ $ åˆ†åˆ¥è¡¨ç¤ºè¡Œçš„é–‹å§‹å’ŒçµæŸï¼Œç¢ºä¿æ•´å€‹å­—ä¸²éƒ½ç¬¦åˆæ•¸å­—æ ¼å¼ã€‚
# \\d+ è¡¨ç¤ºä¸€å€‹æˆ–å¤šå€‹æ•¸å­—ã€‚
# (\\.\\d+)? è¡¨ç¤ºå¯é¸çš„å°æ•¸é»å¾Œé¢è·Ÿè‘—ä¸€å€‹æˆ–å¤šå€‹æ•¸å­—ã€‚

# æŸ¥çœ‹é€™äº›è¨˜éŒ„
non_numeric_entries$coordinateUncertaintyInMeters %>% table()


combine_table_ver2 <- combine_table %>% 
  mutate(
    coordinateUncertaintyInMeters = case_when(
      coordinateUncertaintyInMeters == "<25å…¬å°º" ~ "25",
      coordinateUncertaintyInMeters == "100-500" ~ "500",
      coordinateUncertaintyInMeters == "1e+06" ~ "1000000",
      TRUE ~ coordinateUncertaintyInMeters  # ä¿ç•™å…¶ä»–å€¼ä¸è®Š
    )
  ) %>% 
  mutate(
    coordinateUncertaintyInMeters = as.numeric(coordinateUncertaintyInMeters),  # è½‰æ›ç‚ºæ•¸å€¼å‹
    year = as.character(year)  # ç¢ºä¿ year æ˜¯å­—ç¬¦å‹
  )

# æˆ‘å€‘åªæ˜¯æƒ³ç¹ªè£½åˆ†å¸ƒåœ–
# å¦‚æœæœ‰éå¤šé‡è¤‡è³‡æ–™å¯ä»¥å…ˆæ’é™¤æ‰
combine_table_final <- combine_table_ver2 %>%
  distinct(decimalLatitude, decimalLongitude, .keep_all = TRUE)


fwrite(combine_table_final, "combine_table_final.csv")
```
#### + è¦åˆä½µå…©å€‹ä¸åŒä¾†æºçš„å…¬é–‹è³‡æ–™è«‹ç¢ºèªå…±åŒæ¬„ä½
#### + æª¢æŸ¥å…±åŒæ¬„ä½æ ¼å¼èˆ‡è³‡æ–™å…§å®¹
#### + åˆä½µä¹‹å¾Œå¯æ ¹æ“šç›®çš„åšè³‡æ–™ç¯©é¸èˆ‡æ’é™¤

</br >

## (4)ï¸ ğŸ§­ è³‡æ–™é»ä½è¦–è¦ºåŒ–
#### é»‘å† éº»é·º *Gorsachius melanolophus* ï¼Œæˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹è³‡æ–™åœ¨åœ°åœ–ä¸Šçš„åˆ†å¸ƒ
```{r, message = F}
# ç’°å¢ƒå…§è®Šæ•¸å¤ªå¤šï¼Œæˆ‘å€‘å…ˆæŠŠæ±è¥¿éƒ½æ¸…é™¤
rm(list=ls())

world.map <- ne_countries(returnclass = "sf") # ä¸‹è¼‰ä¸–ç•Œåœ°åœ–

combine_table_final<- read_delim_arrow("combine_table_final.csv", delim = ",")

# ä¸‹è¼‰çš„è³‡æ–™åœ¨ä¸–ç•Œçš„åˆ†å¸ƒ
ggplot() +
  geom_sf(data = world.map) +
  geom_point(data = combine_table_final,
             aes(x = decimalLongitude, # ç¶“åº¦
                 y = decimalLatitude), # ç·¯åº¦
             shape = "+",
             color = "red") +
  theme_bw()
```
```{r, message = F}
tw.map <- ne_countries(country = "Taiwan", scale = "large", returnclass = "sf") # ä¸‹è¼‰è‡ºç£åœ°åœ–

# ä¸‹è¼‰çš„è³‡æ–™åœ¨è‡ºç£çš„åˆ†å¸ƒ
ggplot() +
  geom_point(data = combine_table_final,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +
  geom_sf(data = tw.map) + 
  theme_bw()
# ç¹ªè£½å‡ºä¾†çš„åœ°åœ–ï¼Œå¾ˆæ˜é¡¯çš„è³‡æ–™åˆ†å¸ƒæœ‰å¤§é‡éƒ½ä¸å†è‡ºç£æœ¬å³¶å…§
```
#### é»‘å† éº»é·ºæ˜¯æ±å—äºéƒ½æœƒåˆ†å¸ƒçš„ç‰©ç¨®ï¼Œä½†æˆ‘å€‘åªéœ€è¦å°ç£ç¯„åœå…§çš„è³‡æ–™
#### æˆ‘å€‘ä¾†çœ‹çœ‹è©²æ€éº¼é‡å°é€™æ¨£çš„è³‡æ–™åšæ¸…ç†

</br >

## (4) ğŸš§ è³‡æ–™æ¸…ç†
#### âš ï¸ æ³¨æ„ âš ï¸ æ¸…ç†è³‡æ–™çš„æ­¥é©Ÿæ²’æœ‰çµ±ä¸€çš„ä½œæ³•
#### æ‰€æœ‰æ¸…ç†æ­¥é©Ÿéƒ½æœƒä»¥ä½ çš„ç ”ç©¶ç›®çš„èˆ‡è¦åšçš„åˆ†ææ–¹å¼åšèª¿æ•´
#### æ­¤æ•™æè£¡æåˆ°çš„æ¸…ç†æ­¥é©Ÿæ˜¯ GBIF åŠ ä¸Š TBIA å»ºè­°å¯ä»¥æ³¨æ„çš„åœ°æ–¹

</br >

### 4.1 - æˆ‘åªæƒ³è¦åŸç”Ÿ & é‡ç”Ÿçš„å‡ºç¾ç´€éŒ„ï¼Œå»é™¤å…¸è—è³‡æ–™ï¼
```{r, message = F}
table(combine_table_final$basisOfRecord) # basisOfRecord = è³‡æ–™é¡å‹
table(combine_table_final$establishmentMeans) # establishmentMeans = åŸç”Ÿç‹€æ…‹ã€‚
# é»‘å† éº»é·ºè³‡æ–™æ²’æœ‰å‡ºç¾å…¶ä»–å¤–ä¾†ç¨®è³‡è¨Šï¼Œæˆ‘å€‘å¯ä»¥å…ˆé è¨­ä»–å€‘éƒ½æ˜¯åŸç”Ÿè³‡æ–™ã€‚

clean.step.1 <- combine_table_final %>%
  filter(!basisOfRecord %in% c("FOSSIL_SPECIMEN", "LIVING_SPECIMEN", "PRESERVED_SPECIMEN", "MATERIAL_CITATION")) %>% 
  filter(!establishmentMeans %in% c("MANAGED", "INTRODUCED", "INVASIVE", "NATURALISED"))

print(paste0(nrow(combine_table_final) - nrow(clean.step.1), " records deleted; ",
             nrow(clean.step.1), " records remaining."))


# ä¾†çœ‹ä¸€ä¸‹è³‡æ–™æ¸…é™¤å‰èˆ‡å¾Œçš„åœ°ç†åˆ†å¸ƒ
ggplot() +
  geom_sf(data = world.map) +
  geom_point(data = combine_table_final,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "blue") +  # è¢«ç§»é™¤çš„è³‡æ–™
  geom_point(data = clean.step.1,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +  # ä¿ç•™ä¸‹ä¾†çš„è³‡æ–™
  theme_bw()
```

</br >

### 4.2 - æŠŠä¸€äº›æœ‰æ˜é¡¯åœ°ç†éŒ¯èª¤çš„è³‡æ–™å»é™¤
#### ä½¿ç”¨æ–¹ä¾¿çš„ *`CoordinateCleaner`* å¥—ä»¶
```{r}
# ä»¥ä¸‹è¨»è§£åˆ†åˆ¥ç‚ºæ¸…ç†çš„éƒ¨åˆ†
clean.step.2 <- clean.step.1 %>% 
  filter(!is.na(decimalLatitude), !is.na(decimalLongitude), # ç„¡ç¶“ç·¯åº¦è³‡è¨Š
         countryCode == "TW") %>% # ä¿ç•™åœ¨å°ç£çš„é»ä½
  cc_dupl() %>% # ç¶“ç·¯åº¦é»ä½é‡è¤‡
  cc_zero() %>% # ç¶“ç·¯åº¦ç‚º 0
  cc_equ() %>% # ç¶“ç·¯åº¦ç‚ºåŒæ•¸å€¼
  cc_val() %>% # ç¶“ç·¯åº¦ç„¡æ•ˆ (ç·¯åº¦ > 90 & < -90; ç¶“åº¦ > 180 & < -180)
  cc_sea() %>% # æµ·ä¸Š
  cc_cen(buffer = 5) # åœ‹å®¶çš„ä¸­é–“é»ï¼Œæ•¸å­—å–®ä½æ˜¯å…¬é‡Œ

print(paste0(nrow(clean.step.1) - nrow(clean.step.2), " records deleted; ",
             nrow(clean.step.2), " records remaining."))  
```
```{r, message = F}
# ä¾†çœ‹ä¸€ä¸‹è³‡æ–™æ¸…é™¤å‰èˆ‡å¾Œçš„åœ°ç†åˆ†å¸ƒ
ggplot() +
  geom_sf(data = world.map) +
  geom_point(data = clean.step.1,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "blue") +  # è¢«ç§»é™¤çš„è³‡æ–™
  geom_point(data = clean.step.2,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +  # ä¿ç•™ä¸‹ä¾†çš„è³‡æ–™
  theme_bw()
```

#### ç§»é™¤æˆåŠŸï¼æˆ‘å€‘æ¥ä¸‹ä¾†çœ‹å°ç£çš„è³‡æ–™å°±å¥½
```{r, message = F}
ggplot() +
  geom_sf(data = tw.map) +
  geom_point(data = clean.step.2,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +
  theme_bw()
```

</br >

### 4.3 - ç§»é™¤åº§æ¨™ä¸ç¢ºå®šæ€§å¾ˆé«˜çš„è³‡æ–™
#### å¦‚æœç‰©ç¨®çš„å¯¦éš›é»ä½å°æ¥ä¸‹ä¾†è¦åšçš„åˆ†æå¾ˆé‡è¦
#### æ¯”å¦‚èªªï¼šç”¨ä¾†è·‘ç‰©ç¨®åˆ†å¸ƒæ¨¡å‹
#### é‚£å¿…é ˆé‡å° coordinateUncertaintyInMeters (åº§æ¨™ä¸ç¢ºå®šæ€§) æ¬„ä½åšé©ç•¶çš„æ¸…ç†
```{r}
table(clean.step.2$coordinateUncertaintyInMeters)

clean.step.3 <- clean.step.2 %>% 
  filter(!is.na(coordinateUncertaintyInMeters) |  # ç§»é™¤ç©ºå€¼
           coordinateUncertaintyInMeters < 1000)  # ä¿ç•™ < 1000 å…¬å°ºä»¥ä¸‹çš„

print(paste0(nrow(clean.step.2) - nrow(clean.step.3), " records deleted; ",
             nrow(clean.step.3), " records remaining." ))  

ggplot() +
  geom_sf(data = tw.map) +
  geom_point(data = clean.step.3,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +
  theme_bw()
```

</br >

### 4.4 - ç§»é™¤æµ·æ‹”éé«˜çš„è³‡æ–™
#### é»‘å† éº»é·ºçš„æµ·æ‹”å¹³å‡åˆ†å¸ƒå¤§æ¦‚ä½æ–¼ 1000 ä»¥ä¸‹
```{r}
ele_raster <- raster("C:/Users/taibi/OneDrive/Desktop/202411_rgbif/input/polygon/twdtm_asterV2_30m.tif")
clean.step.3_sf<- clean.step.3 %>%
  st_as_sf(coords = c("decimalLongitude", "decimalLatitude"), remove=FALSE) %>% # set coordinates
  st_set_crs(4326)

clean.step.3_sf$elevation <- extract(ele_raster, clean.step.3_sf)
clean.step.4 <- clean.step.3_sf %>% 
  st_drop_geometry(.) %>% 
  filter(!(elevation>1000))
  
ggplot() +
  geom_sf(data = tw.map) +
  geom_point(data = clean.step.4,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +
  theme_bw()

print(paste0(nrow(clean.step.3) - nrow(clean.step.4), " records deleted; ",
             nrow(clean.step.4), " records remaining." )) 
```

</br >

### 4.5 - æˆ‘å°å¾ˆèˆŠæˆ–ç„¡å¹´ä»½çš„ç´€éŒ„æœ‰ç–‘æ…®ï¼Œç§»é™¤ï¼
#### åœ¨ GBIF è£¡ï¼Œå¾ˆèˆŠçš„ç´€éŒ„é€šå¸¸æ˜¯æ¨™æœ¬
```{r}
# è¦–æƒ…æ³è‡ªå·±å®šç¾©è©²ä¿ç•™ä»€éº¼å¹´ä»½
table(clean.step.4$year)

clean.step.5 <- clean.step.4 %>% 
  filter(year > 1980 & year < 2025) # æœ‰äº›è³‡æ–™ä¹Ÿæœƒå‡ºç¾â€œæœªä¾†â€å¹´ä»½ï¼Œç§»é™¤
```

</br >

### 4.6 - æœ€å¾Œæª¢è¦–åˆ°åº•è¢«ç§»é™¤å¤šå°‘æœ‰ç–‘æ…®çš„è³‡æ–™
```{r, message = F}
ggplot() +
  geom_sf(data = tw.map) +
  geom_point(data = combine_table_final,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "blue") +  # æ‰€æœ‰è¢«ç§»é™¤çš„è³‡æ–™
  geom_point(data = clean.step.5,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +  # æ¸…ç†å¾Œï¼Œä¿ç•™ä¸‹ä¾†çš„è³‡æ–™
  theme_bw() +
  coord_sf(xlim = st_bbox(tw.map)[c(1,3)],
           ylim = st_bbox(tw.map)[c(2,4)])
```

### 4.7 - æ¸…ç†å¾Œï¼Œå‰©ä¸‹çš„è³‡æ–™
```{r}
ggplot() +
  geom_sf(data = tw.map) +
  geom_point(data = clean.step.5,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +
  theme_bw()
```

#### æ¸…ç†å¾Œèƒ½ç”¨çš„è³‡æ–™å¾å‰›é–‹å§‹çš„ 25,244 ç­†åˆ°åªå‰© 4890 ç­† (æ“ä½œæ™‚é–“ï¼š10/30) 
#### ç•¶ç„¶ä¹Ÿå¯èƒ½æ˜¯å› ç‚ºå°è³‡æ–™å“è³ªçš„è¦æ±‚å¤ªåš´æ ¼äº†
#### å†è¦–æƒ…æ³è‡ªå·±èª¿æ•´å•¦ï½ 

</br >

## (5) ğŸ—º ä¾†å€‹åœ–å±¤ + ç¶²æ ¼æ•™å­¸
### ä¸‹è¼‰ GBIF ç‰¹å®šç¯„åœçš„ç‰©ç¨®å‡ºç¾ç´€éŒ„
```{r}
location <- "POLYGON((121.61304 25.04929, 121.61085 25.0495, 121.60583 25.04833, 121.60672 25.04555, 121.60627 25.04138, 121.60915 25.03876, 121.61668 25.03708, 121.61675 25.03795, 121.61759 25.03972, 121.61724 25.04091, 121.61682 25.04208, 121.61624 25.04317, 121.61507 25.04574, 121.61554 25.0474, 121.61563 25.0488, 121.61304 25.04929))"


# å¦ä¸€ç¨®æ›´å¿«é€Ÿç¯©é¸ã€é¸æ“‡ç‰¹å®šç¯„åœèˆ‡ä¸‹è¼‰ GBIF è³‡æ–™çš„æ–¹æ³•
taxonKey <- 2480841
gbif_download_key <- occ_download(pred("taxonKey", taxonKey),
                                  pred_within(location),
                                  pred_or(pred_lt("coordinateUncertaintyInMeters", 1000),
                                          pred_notnull("coordinateUncertaintyInMeters")),
                                  format = "SIMPLE_CSV",
                                  user = "yourID", # è¼¸å…¥ä½ çš„ GBIF User ID
                                  pwd = "yourPW", # å¯†ç¢¼
                                  email = "yourEmail@gmail.com") # ç”¨ä¾†è¨»å†Š GBIF å¸³è™Ÿçš„ email

# ä¸‹è¼‰ä¸¦è§£å£“ç¸®
gbif_download_metadata <- occ_download_wait(gbif_download_key)
gbif_download_path <- "./gbif_download.zip" # æŒ‡å®šä¸‹è¼‰æª”æ¡ˆçš„è·¯å¾‘
download.file(gbif_download_metadata$downloadLink, gbif_download_path) # ä¸‹è¼‰åˆ°æœ¬æ©Ÿ
unzip(gbif_download_path) # åœ¨æœ¬æ©Ÿå£“ç¸®ä¸‹è¼‰æª”

GBIF_data <- fread(sprintf("%s.csv", gbif_download_metadata$key), 
                   sep = "\t", fill = T, encoding = "UTF-8", colClasses = "character", quote = "")


# å°‡ WKT è½‰æ›ç‚º sf object
sfc <- st_as_sfc(location)
polygon_sf <- st_sf(geometry = sfc)

# åŠƒå¤šé‚Šå½¢ (é€™æ˜¯ WGS84)
ggplot() +
  geom_sf(data = polygon_sf,
          color = "black", size = 0.2, inherit.aes = F, alpha = 0.3)

# è¨­å®šåŸå§‹åæ¨™ç³»çµ± (å…ˆå‘Šè¨´ R é è¨­åœ–å±¤æ˜¯æ˜¯ WGS84, EPSG:4326)
st_crs(polygon_sf) <- 4326

# è¦è½‰æ›åˆ° TWD97 (EPSG:3826)ã€‚ç¹ªè£½ç¶²æ ¼å¿…é ˆè¦è®“åæ¨™ç³»çµ±è½‰æ›æˆäºŒåº¦åˆ†å¸¶æ‰ç²¾æº–
polygon_sf_twd97 <- st_transform(polygon_sf, 3826)

# å‰µå»º 100m x 100m çš„ç¶²æ ¼
grid <- st_make_grid(polygon_sf_twd97, cellsize = c(100, 100)) %>% 
  st_as_sf()

# ç•«å‡º grid
ggplot() +
  geom_sf(data = grid,
          color = "black", size = 0.2, inherit.aes = F, alpha = 0.3)

# ç”¨ç”¢ç”Ÿçš„ Polygon æŒ‘é¸ç¶²æ ¼
intersects_result <- st_intersects(grid, polygon_sf_twd97)
selected_grids <- grid[unlist(lapply(intersects_result, length)) > 0, ]

# ç•«å‡ºç¯©é¸ grid èˆ‡å¤šé‚Šå½¢é‡ç–Šåœ–
ggplot() +
  geom_sf(data = selected_grids, fill = "red", alpha = 0.5) + # ç¹ªè£½ selected_grids
  geom_sf(data = polygon_sf_twd97, fill = "lightblue") + # ç¹ªè£½ polygon_sf_twd97
  theme_minimal()


# å°‡ GBIF_data æ ¹æ“šåº§æ¨™è½‰æˆ Point polygonï¼Œå› åº§æ¨™æœ¬èº«æ˜¯WGS84ï¼Œæ•…æŠ•å½±æˆWGS84
GBIF_sf <- st_as_sf(GBIF_data, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)

# ç•«å‡º GBIF é»ä½åœ–
ggplot() +
  geom_sf(data = GBIF_sf)


# ç•«å‡º GBIF é»ä½ä»¥åŠç¯©é¸ grid é‡ç–Šåœ–
ggplot() +
  geom_sf(data = selected_grids, fill = "red", alpha = 0.5) + # ç¹ªè£½ selected_grids
  geom_sf(data = GBIF_sf)+
  theme_minimal()


# å› ç‚º GBIF çš„è³‡æ–™çš„åº§æ¨™ç³»çµ±åŸæœ¬éƒ½æ˜¯ WGS84ï¼Œå°‡é»ä½åœ–å±¤è½‰æˆ TWD97
GBIF_sf_TWD97 <- st_transform(GBIF_sf, crs = 3826)

# ç”¢ç”Ÿé‚è¼¯çŸ©é™£ï¼Œåˆ¤æ–·å…©å€‹åœ–å±¤æœ‰å¤šå°‘è³‡æ–™æœ‰äº¤é›†
points_per_grid <- st_intersects(GBIF_sf_TWD97, selected_grids, sparse = F)

# å°‡é‚è¼¯èˆ‰è­‰è½‰æ›æˆæ•¸åˆ—ï¼Œè¨ˆç®—æ¯å€‹ç¶²æ ¼æœ‰å¤šå°‘é»ä½æ•¸é‡
count_points <- apply(points_per_grid, 2, sum)
selected_grids$count <- count_points

# ç¹ªè£½ç†±é»åœ–
ggplot(data = selected_grids) +
  geom_sf(aes(fill = count), color = "black", size = 0.2) +
  scale_fill_gradientn(colors = c("white", "blue", "red"), 
                       values = scales::rescale(c(0, 1, max(selected_grids$count, na.rm = T))),
                       na.value = "white", 
                       name = "Count") +
  theme_minimal() +
  labs(title = "Selected Grids based on Count", x = "Longitude", y = "Latitude")

# å°‡å®Œæˆçš„ç¶²æ ¼è¼¸å‡ºæˆ shapefileï¼Œå¯ä»¥åœ¨ GIS è»Ÿé«”ä¸Šæ“ä½œç·¨è¼¯
#st_write(selected_grids, "RGBIF_result.shp")
```

</br >


## (6) ğŸŒ å¼•ç”¨æ–¹æ³•
```{r}
gbif_download_key

print(gbif_citation(occ_download_meta(gbif_download_key))$download)
```

</br >

### ğŸ’ å…¶ä»–
#### å¦‚æœæƒ³è©¦åˆ¥çš„ç‰©ç¨®è³‡æ–™ï¼š
```{r}
#name_backbone(name = "Macaca cyclopis", rank = "species") # è‡ºç£ç¼çŒ´
#name_backbone(name = "Odorrana swinhoana", rank = "species") # æ–¯æ–‡è±ªæ°è›™
#name_backbone(name = "Yuhina brunneiceps", rank = "species") # å† ç¾½ç•«çœ‰
#name_backbone(name = "Alpinia uraiensis", rank = "species") # çƒä¾†æœˆæ¡ƒ
```

</br >

### ğŸ“š å»¶ä¼¸é–±è®€
1. GBIF interpreted data - [Issues and Flags](https://data-blog.gbif.org/post/issues-and-flags/) 
2. List of [Darwin Core Term](https://dwc.tdwg.org/list/)
3. Data blog - [GBIF API beginners guide](https://data-blog.gbif.org/post/gbif-api-beginners-guide/)
4. Data blog - [GBIF Species API](https://data-blog.gbif.org/post/gbif-species-api/)
5. GBIF å‡ºç‰ˆæ–‡ä»¶ - [è³‡æ–™å“è³ªåŸå‰‡](https://www.gbif.org/document/80509/principles-of-data-quality) ([è‹±](https://assets.ctfassets.net/uo17ejk9rkwj/2gupj7dJIw62UeOUYiqSsm/0a4bb732bd7fd8cf28f7703dc20a43ba/Data_Quality_-_ENGLISH.pdf)/[ä¸­è­¯](https://assets.ctfassets.net/uo17ejk9rkwj/3IabOUm6FWoikQKceYIQ8g/59fa78644598800faa096c157ce36b03/Principles_20of_20Data_20Quality_20-_20Chinese.pdf))
6. GBIF å‡ºç‰ˆæ–‡ä»¶ - [åŸå§‹ç‰©ç¨®èˆ‡ç‰©ç¨®å‡ºç¾ç´€éŒ„è³‡æ–™](https://www.gbif.org/document/80528/principles-and-methods-of-data-cleaning-primary-species-and-species-occurrence-data)
7. [TBIA API èª¬æ˜æ–‡ä»¶](https://tbiadata.tw/zh-hant/api/doc)

</br >

### ğŸ’¡ åƒè€ƒ
1. **Main reference for this course material / Modified from:** GBIF Secretariat (2021) GBIF Biodiversity Data Use Course. 6th edition. GBIF Secretariat: Copenhagen. https://doi.org/10.15468/ce-wkk4-2w26. 

2. Chamberlain S, Barve V, Mcglinn D, Oldoni D, Desmet P, Geffert L, Ram K (2023). rgbif: Interface to the Global Biodiversity Information Facility API. R package version 3.7.7.6, https://CRAN.R-project.org/package=rgbif.

</br >

***
> This document is part of a course materials developed for [TaiBIF](https://portal.taibif.tw/) Data Use Workshop (2024-11-08).

